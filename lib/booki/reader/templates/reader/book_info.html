{% extends "base.html" %}
{% load i18n messaging_tags booki_tags %}

{% block header %}
<title>{% blocktrans with book.title as booktitle %}{{ booktitle }}{% endblocktrans %}</title>
<link type="text/css" href="{{ request.META.SCRIPT_NAME }}/site_static/css/editor.css" rel="Stylesheet" />
<link rel="alternate" type="application/atom+xml" title="Atom feed for {{ book.title }}" href="{{ request.META.SCRIPT_NAME }}/feeds/atom/book/{{ book.url_title }}/" /> 
{% if has_css %}
<link type="text/css" href="{{ request.META.SCRIPT_NAME }}/static/css/book.{{ book.url_title }}.css" rel="Stylesheet" />

{% endif %}

<link href="{{ request.META.SCRIPT_NAME }}/site_static/css/jquery.bubblepopup.v2.3.1.css" rel="stylesheet" type="text/css" />
<script src="{{ request.META.SCRIPT_NAME }}/site_static/js/jquery.bubblepopup.v2.3.1.min.js" type="text/javascript"></script>

<script type="text/javascript">
 $(function() {


     $('a.user').CreateBubblePopup({
                                  selectable: false,
                                  position: 'top',
                                  align: 'center',
                                  innerHtml: '<div style="height: 50px"><img src="{{ request.META.SCRIPT_NAME }}/site_static/images/loading.gif" style="border:0px; vertical-align:middle; margin-right:10px; display:inline;" />loading!</div>',
                                  innerHtmlStyle: { color:'#000000', 'text-align':'center' },
                                  themeName: 'grey',
                                  themePath: '{{ request.META.SCRIPT_NAME }}/site_static/images/jquerybubblepopup-theme'
                                  });

     $('A.user').mouseover(function(){
				var lnk = $(this);

				$.get('{{ request.META.SCRIPT_NAME }}/_utils/profileinfo/'+lnk.html()+'/', function(data) {
                                       lnk.SetBubblePopupInnerHtml(data, false);
                                });
                             });

     $('A.attachment').CreateBubblePopup({
                                  selectable: false,
                                  position: 'top',
                                  align: 'center',
                                  innerHtml: '<div style="height: 150px"><img src="{{ request.META.SCRIPT_NAME }}/site_static/images/loading.gif" style="border:0px; vertical-align:middle; margin-right:10px; display:inline;" />loading!</div>',
                                  innerHtmlStyle: { color:'#000000', 'text-align':'center' },
                                  themeName: 'grey',
                                  themePath: '{{ request.META.SCRIPT_NAME }}/site_static/images/jquerybubblepopup-theme'
                                  });

     $('A.attachment').mouseover(function(){
				var lnk = $(this);

				$.get('{{ request.META.SCRIPT_NAME }}/_utils/attachmentinfo/{{book.url_title}}/{{book_version}}/'+lnk.html(), function(data) {
                                       lnk.SetBubblePopupInnerHtml(data, false);
                                });
                             });

     $("A.editinfo").booksparkEditBookInfo({"url": "{% url edit_info book.url_title %}"});
     $("A.deletebook").booktypeDeleteBook({"url": "{% url book_delete book.url_title %}"});
 
 });
</script>

<meta property="og:title" content="{{ book.title }}" />
<meta property="og:type" content="book" />
<meta property="og:url" content="http://books.okf.fi/{{ book.url_title }}/_info/" />
<meta property="og:image" content="http://books.okf.fi/{{ book.url_title }}/_info/cover.jpg" />
<meta property="fb:admins" content="717291093" />
<meta property="fb:app_id" content="417294881635669" />
<meta property="og:description" content="{{ book_description|safe }}"/>

{% if book.hidden %}
<meta name="robots" content="noindex, nofollow" />
{% endif %}

{% endblock %}

{% block sidebar %}
<div style="margin-left:5px;width:100%; border: 1px solid #c0c0c0; background-color: #FFFFFF; padding: 5px;" id="mood">
{% if request.user.is_authenticated %}
{% book_followbutton book.url_title request.user.username %}
<br>
{% book_messagefield book.url_title %}
<br>
{% endif %}
{% book_timeline book.url_title %}
</div>
{% endblock %}

{% block content %}
<h2>{{ book.title }}</h2>
<div class="padded" itemscope itemtype="http://schema.org/Book">
<div class="action-menu big">
    <a itemprop="url" class="prime viewdraft" href="/{{ book.url_title }}/"><nobr>Lue kirjaa</nobr></a>
    <a itemprop="url" class="prime viewdraft" href="/{{ book.url_title }}/_full/"><nobr>Koko kirja</nobr></a>
    <a class="prime editbook" href="{% url edit_book book.url_title  %}"><nobr>{% trans "Edit this Book" %}</nobr></a>
    {% if is_book_admin %}
        <a class="prime viewdraft editinfo" href="#"><nobr>{% trans "Edit book info" %}</nobr></a>
        <a class="prime viewdraft deletebook" href="#"><nobr>{% trans "Delete book" %}</nobr></a>

    {% endif %}
</div>
<h3>Kirjan tiedot</h3>
<div class="book-cover">{% if book.cover %}<img itemprop="image" src="cover.jpg"/>{% endif %}</div>
<p class="book-description" itemprop="description">{{ book_description|safe }}</p>
<p style="display:none;" itemprop="name">{{ book.title }}</p>
<p style="clear:both; margin-top:0;">&nbsp;</p>
<ul id="bookdetails">
  <li><b>{% trans "Owner:" %}</b> <a itemprop="author" href="{% url view_profile book.owner.username %}" class="user">{{ book.owner.username }}</a></li>
  <li><b>{% trans "Status:" %}</b> {{ book.status.name }}

{% if book.hidden %}
  <i>{% trans "(this book is hidden from others)" %}</i>
{% else %}
  <i>{% trans "(this book is visible to everyone)" %}</i>
{% endif %}
  </li>
{% if book.group %}
  <li><b>{% trans "Member of group:" %}</b> <a itemprop="publisher" href="{% url view_group book.group.url_name %}">{{ book.group.name }}</a></li>
{% endif %}
  <li><b>{% trans "Current version:" %}</b> <a itemprop="version" href="{% url draft_book book.url_title book_version %}">{{ book.version.getVersion }}</a></li>

  <li>&nbsp;</li>
  <li><b>{% trans "Created:" %}</b> <i itemprop="dateCreated">{{ book.created }}</i></li>
  <li><b>{% trans "Published:" %}</b> <i itemprop="datePublished">{{ book.published }}</i></li>
  <li>&nbsp;</li>
<li>
<b>{% trans "Collaborators:" %}</b>
{% for username in book_collaborators %}
  <a itemprop="author" href="{% url view_profile username %}" class="user">{{ username }}</a>
  {% if not forloop.last %},{% endif %}
{% endfor %}
</li>
{% if online_users %}
<li>
<b>{% trans "Online editing:" %}</b> 
{% for username in online_users %}
  <a href="{% url view_profile username %}" class="user">{{ username }}</a>
  {% if not forloop.last %},{% endif %}
{% endfor %}
</li>
{% endif %}
</ul>

<h3 class="inner">{% trans "Versions" %}</h3>
<ul class="simple-list solo no-bg">
 {% for ver in book_versions %}
   <li><a href="{% url draft_book book.url_title ver.getVersion %}"> {{ ver.getVersion }}</a></li>
 {% endfor %}
</ul>

<h3 class="inner">{% trans "Recent activity" %}</h3>
<table class="basic-table" border="0" width="100%">
 {% for ln in book_history %}
   <tr itemscope itemtype="http://schema.org/UpdateAction">
       {% if ln.kind == 1 %}
       <td valign="top" itemprop="name"> 
         {% trans "Chapter create" %}
       </td>
       {% else %}
         {% if ln.kind == 2 %}
           <td valign="top" itemprop="name"> 
             {% trans "Chapter save" %}
           </td>
         {% else %}
           {% if ln.kind == 3 %}
             <td valign="top" itemprop="name"> 
               {% trans "Chapter rename" %}
             </td>
           {% else %}
             {% if ln.kind == 4 %}
               <td valign="top" colspan="2" itemprop="name"> 
                 {% trans "Chapter reorder" %}
               </td>
             {% else %}
               {% if ln.kind == 5 %}
                  <td valign="top" colspan="2" itemprop="name"> 
                    {% trans "Split chapter" %}
                  </td>
               {% else %}
                 {% if ln.kind == 6 %}
                   <td valign="top" colspan="2" itemprop="name"> 
                     {% trans "Section create" %}
                   </td>
                 {% else %}
                   {% if ln.kind == 10 %}
                     <td valign="top" colspan="2" itemprop="name"> 
                       {% trans "Book create" %}
                     </td>
                   {% else %}
                     {% if ln.kind == 11 %}
                       <td valign="top" colspan="2" itemprop="name"> 
                         {% trans "Minor version" %}
                       </td>
                     {% else %}
                       {% if ln.kind == 12 %}
                         <td valign="top" colspan="2" itemprop="name"> 
                           {% trans "Major version" %}
                         </td>
                       {% else %}
                         {% if ln.kind == 13 %}
                           <td valign="top" colspan="2" itemprop="name"> 
                             {% trans "Uploaded" %} "<a itemprop="image" class="attachment" href="{% url draft_attachment book.url_title book_version ln.args|jsonlookup:"filename" %}">{{ ln.args|jsonlookup:"filename" }}</a>"
                           </td>
                         {% else %}
                           {% if ln.kind == 19 %}
                             <td valign="top" colspan="2" itemprop="name"> 
                               {% trans "Delete chapter" %}
                              </td>        
                           {% else %}
                             {% if ln.kind == 16 %}
                               <td valign="top" colspan="2" itemprop="name"> 
                                 {% trans "Upload cover" %}
                                </td>        
                             {% else %}
                               {% if ln.kind == 17 %}
                                 <td valign="top" colspan="2" itemprop="name"> 
                                   {% trans "Delete cover" %}
                                  </td>        
                               {% else %}
                                 {% if ln.kind == 14 %}
                                   <td valign="top" colspan="2" itemprop="name"> 
                                     {% trans "Attachment delete" %}
                                    </td>        
                                 {% else %}
                                  <td colspan="2"></td>
                                 {% endif %}
                               {% endif %}
                             {% endif %}
                           {% endif %}
                         {% endif %}
                       {% endif %}
                     {% endif %}
                   {% endif %}
                 {% endif %}
               {% endif %}
             {% endif %}
           {% endif %}
         {% endif %}
       {% endif %}

       {% if ln.chapter %}
         <td valign="top"> 
           <a itemprop="url" href="{% url draft_chapter book.url_title  book_version  ln.chapter.url_title %}">{{ln.chapter.title}}</a>
         </td>
       {% endif %}

     <td valign="top"> <a itemprop="agent" href="{% url view_profile ln.user.username %}" class="user">{{ ln.user.username }}</a> </td>
     <td itemprop="endtime" valign="top"> {{ ln.modified }} </td>
   </tr>
 {% endfor %}
</table>
<div style="padding: 10px 0 20px 0;">
  <a class="rss" href="{{ request.META.SCRIPT_NAME }}/feeds/atom/book/{{ book.url_title }}">{% trans "Follow changes" %}</a>
</div>

</div>
{% endblock %}
